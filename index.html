<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Final Fix</title>
    <style>
        :root { --main: #24A1DE; --bg: #8fb1ce; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        html, body { 
            width: 100%; height: 100%; 
            overflow: hidden; position: fixed; 
            background: var(--bg);
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .card { 
            background: white; width: 100%; max-width: 450px; 
            height: 100%; margin: 0 auto;
            display: flex; flex-direction: column; position: relative; 
        }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column; 
            z-index: 500; padding: 30px; justify-content: center;
        }
        
        .hidden { display: none !important; }

        input { 
            border: 1px solid #ccc; padding: 15px; background: #fdfdfd; 
            border-radius: 12px; width: 100%; font-size: 16px; margin-bottom: 12px;
            -webkit-appearance: none; 
        }

        .btn-main { 
            background: var(--main); color: white; border: none; 
            padding: 16px; border-radius: 12px; font-weight: bold; 
            width: 100%; font-size: 16px; cursor: pointer;
        }

        .header { background: var(--main); color: white; padding: 12px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #e6eef3; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen">
        <h2 style="text-align:center; color: var(--main); margin-bottom: 25px;">Cloud Messenger</h2>
        <input type="email" id="email" placeholder="Email" inputmode="email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="handleAuth()" class="btn-main">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
        <p id="loader-status" style="font-size: 12px; color: gray; text-align: center; margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</p>
    </div>

    <div id="app" class="card hidden">
        <div class="header">
            <div onclick="location.reload()" style="font-size: 20px;">üè†</div>
            <b id="display-name-top">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</b>
        </div>
        <div id="messages"></div>
        <div style="padding: 12px; background: white; display: flex; gap: 8px; border-top: 1px solid #eee;">
            <input type="text" id="msg-text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendMsg()" style="padding: 0 15px; border:none; background:var(--main); color:white; border-radius:10px;">üöÄ</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCuDXnXksaxGp_-Oml82uuymgXNRDRS37Y",
            authDomain: "mymessenger-2b9d0.firebaseapp.com",
            projectId: "mymessenger-2b9d0",
            storageBucket: "mymessenger-2b9d0.firebasestorage.app",
            messagingSenderId: "1023277743941",
            appId: "1:1023277743941:web:ae94eaed1c12b30795082c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth(), db = firebase.firestore();
            document.getElementById('loader-status').innerText = "–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ";

            window.handleAuth = async () => {
                const e = document.getElementById('email').value, p = document.getElementById('pass').value;
                if(!e || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
                auth.signInWithEmailAndPassword(e, p).catch(() => auth.createUserWithEmailAndPassword(e, p));
            };

            auth.onAuthStateChanged(user => {
                if(user) {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    db.collection("users").doc(user.uid).set({ 
                        username: "id" + user.uid.slice(0,5),
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }, {merge: true});
                }
            });

            window.sendMsg = async () => {
                const t = document.getElementById('msg-text').value; if(!t) return;
                // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID –¥–ª—è —Ç–µ—Å—Ç–∞, –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–∏—Å–∫–∞
                const id = "global_chat"; 
                await db.collection("chats").doc(id).collection("messages").add({
                    sender: auth.currentUser.uid, text: t, time: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('msg-text').value = "";
            };
            
        } catch (e) {
            document.getElementById('loader-status').innerText = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
            console.error(e);
        }

        // –§–∏–∫—Å –ø–æ–ª–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è iOS
        setTimeout(() => { window.scrollTo(0, 0); }, 100);
    </script>
</body>
</html>
